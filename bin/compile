#!/usr/bin/env bash

build_dir=$1
env_dir=${3:-}

to_create="he en mx"
folders_to_copy="actions admin_area api appConfigs cache errors files images includes js partners player plugins styles web_app web_app_public"

ls

howmany() { echo $#; }

export_env_dir() {
  env_dir=$1
  acceptlist_regex=${2:-''}
  target_file=$3
  denylist_regex=${4:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  echo "editing $target_file with RE $acceptlist_regex"
  if [ -d "$env_dir" ]; then
	all_env="$(ls $env_dir)"
	howmany $all_env
	whitelisted=$(echo $all_env | tr ' ' '\n' | grep -E "$acceptlist_regex")
	howmany $whitelisted
	blacklisted=$(echo $whitelisted | tr ' ' '\n' | grep -vE "$denylist_regex")
	howmany $blacklisted
    for e in $blacklisted; do
	  echo "append $e=$(cat $env_dir/$e)"
	  echo "$e=$(cat $env_dir/$e)" >> "$target_file"
    done
  fi
}

for lang in $to_create; do
	echo $lang
	mkdir -p $build_dir/$lang
	cp -ps $build_dir/*.php $build_dir/$lang
	echo 'dirs'
	# cp -ps $build_dir/.htaccess $build_dir/$lang
	for val in $folders_to_copy; do
		cp -pRs $build_dir/$val $build_dir/$lang
	done
	echo "copying $build_dir/.htaccess to $build_dir/$lang/.htaccess"
	cp -p $build_dir/.htaccess $build_dir/$lang/.htaccess
	echo "making $build_dir/$lang/.env"
	touch $build_dir/$lang/.env
	echo > $build_dir/$lang/.env
	export_env_dir "$env_dir" "^${lang^^}_.*" "$build_dir/$lang/.env"
done
echo "removing $build_dir/.htaccess"
rm $build_dir/.htaccess
